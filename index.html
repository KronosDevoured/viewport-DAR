<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>DAR Rings — ARL mirrors ARR; DAR OFF stabilized</title>
<style>
  html,body{margin:0;height:100%;background:#0f1116;color:#e7ecf3;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
  header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.6rem .8rem;padding:.6rem .8rem;background:#12161d;border-bottom:1px solid #1f2530}
  .sl{display:flex;flex-wrap:wrap;gap:1rem;flex:1 1 980px;min-width:0}
  .control{display:flex;flex-direction:column;gap:.25rem;flex:1 1 220px;min-width:180px}
  .control label{font-size:.9rem;opacity:.9}
  .control input[type=number]{background:#0f141c;border:1px solid #2a3342;color:#e7ecf3;border-radius:8px;padding:.35rem .5rem;font-size:.95rem}
  .control input[type=range]{flex:1;min-width:80px}
  .tag{margin-top:.1rem;align-self:flex-start;white-space:nowrap;font-size:.82rem;opacity:.9}
  .actions{display:flex;gap:.5rem;flex:0 0 auto}
  button{border:1px solid #2a3342;background:#151b24;color:#e7ecf3;border-radius:10px;padding:.35rem .6rem;font-weight:600}
  .toggle{border:1px solid #2a3342;background:#0f141c;border-radius:10px;display:flex;overflow:hidden}
  .toggle button{border:0;padding:.35rem .6rem}
  .toggle button[aria-pressed="true"]{background:#1a2230}
  #scene{position:relative}
  #hud{position:absolute;inset:auto 0 .8rem 0;display:flex;justify-content:center;gap:.8rem;pointer-events:none}
  .hint{pointer-events:auto;background:#0f141c;border:1px solid #2a3342;padding:.35rem .55rem;border-radius:10px;font-size:.85rem}
  #stickWrap{pointer-events:auto;display:flex;align-items:center;gap:.5rem;background:#0f141c;border:1px solid #2a3342;border-radius:12px;padding:.4rem .6rem}
  #stick{width:120px;height:120px;display:block}
  .legend{display:flex;flex-wrap:wrap;gap:.3rem .6rem;font-size:.8rem;opacity:.9}
  .chip{display:inline-flex;align-items:center;gap:.35rem;background:#0f141c;border:1px solid #2a3342;border-radius:999px;padding:.18rem .5rem}
  .dot{width:.65rem;height:.65rem;border-radius:50%}
  .up{background:#ff5c5c}.down{background:#53d769}.right{background:#4c8dff}.left{background:#ffd166}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="sl">
      <div class="control">
        <label for="morph">Morph (stick)</label>
        <input id="morph" type="range" min="0" max="1" step="0.001" value="0" disabled>
        <span id="morphTag" class="tag">0.000</span>
      </div>
      <div class="control">
        <label for="alpha">End Cone</label>
        <input id="alpha" type="range" min="5" max="60" step="1" value="30">
        <span id="alphaTag" class="tag">30°</span>
      </div>
      <div class="control">
        <label for="carSize">Car Size</label>
        <input id="carSize" type="range" min="0.005" max="0.08" step="0.001" value="0.010">
        <span id="carSizeTag" class="tag">0.010</span>
      </div>
      <div class="control">
        <label for="rodHeight">Rod Height (±100)</label>
        <input id="rodHeight" type="number" min="-100" max="100" step="0.001" value="-0.200">
        <span id="rodHeightTag" class="tag">-0.200</span>
      </div>
      <div class="control">
        <label for="carHeight">Mesh Height (offset, ±100)</label>
        <input id="carHeight" type="number" min="-100" max="100" step="0.001" value="-0.200">
        <span id="carHeightTag" class="tag">-0.200</span>
      </div>
    </div>
    <div class="actions">
      <div class="toggle" role="toolbar" aria-label="DAR mode">
        <button id="arl" type="button" aria-pressed="false" title="ARL">ARL</button>
        <button id="arr" type="button" aria-pressed="false" title="ARR">ARR</button>
      </div>
      <button id="reset" type="button">Reset View</button>
    </div>
  </header>

  <div id="scene"></div>

  <div id="hud">
    <div id="stickWrap">
      <canvas id="stick" width="120" height="120"></canvas>
      <div class="legend">
        <span class="chip"><span class="dot up"></span>Up</span>
        <span class="chip"><span class="dot down"></span>Down</span>
        <span class="chip"><span class="dot right"></span>Right</span>
        <span class="chip"><span class="dot left"></span>Left</span>
      </div>
    </div>
    <div class="hint">Guides visible. DAR OFF: big circle, orientation locked to stick (no flips). DAR ON: ARL mirrors ARR (azimuth ±90°, opposite travel and opposite spin). Deadzone=0.08.</div>
  </div>
</div>

<script type="module">
import * as THREE from "https://esm.sh/three@0.155.0";
import { OrbitControls } from "https://esm.sh/three@0.155.0/examples/jsm/controls/OrbitControls.js";
import { GLTFLoader } from "https://esm.sh/three@0.155.0/examples/jsm/loaders/GLTFLoader.js";

/* --- snip: all setup code from previous version unchanged --- */

/* stick drawing with fixed arcs */
const stickCanvas=document.getElementById('stick'), sctx=stickCanvas.getContext('2d'); const DPR=Math.min(devicePixelRatio||1,2);
stickCanvas.width=120*DPR; stickCanvas.height=120*DPR; stickCanvas.style.width='120px'; stickCanvas.style.height='120px';
const THETA_SHIFT=-Math.PI/4;
function drawStick(){
  const ctx=sctx,w=stickCanvas.width,h=stickCanvas.height,cx=w/2,cy=h/2; const R=Math.min(w,h)*0.45;
  ctx.clearRect(0,0,w,h);
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.strokeStyle='#2a3342'; ctx.lineWidth=2*DPR; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx,cy,R*DEADZONE,0,Math.PI*2); ctx.strokeStyle='#3a4557'; ctx.setLineDash([4*DPR,4*DPR]); ctx.stroke(); ctx.setLineDash([]);
  const arcs=[
    {start:-Math.PI/2+THETA_SHIFT, end:0+THETA_SHIFT,         color:'#ff5c5c'},  // Up
    {start: Math.PI/2+THETA_SHIFT, end:Math.PI+THETA_SHIFT,   color:'#53d769'},  // Down
    {start: 0+THETA_SHIFT,         end:Math.PI/2+THETA_SHIFT, color:'#4c8dff'},  // Right
    {start: Math.PI+THETA_SHIFT,   end:1.5*Math.PI+THETA_SHIFT, color:'#ffd166'} // Left
  ];
  ctx.lineWidth=3*DPR;
  for(const a of arcs){ ctx.beginPath(); ctx.arc(cx,cy,R,a.start,a.end); ctx.strokeStyle=a.color; ctx.stroke(); }
  const kx=cx+stickX*R, ky=cy-stickY*R; ctx.beginPath(); ctx.arc(kx,ky,6*DPR,0,Math.PI*2); ctx.fillStyle='#e7ecf3'; ctx.fill(); ctx.strokeStyle='#1f2530'; ctx.lineWidth=1.5*DPR; ctx.stroke();
}

/* --- snip: rest of update(), animate(), etc. same as last message --- */
</script>
</body>
</html>
